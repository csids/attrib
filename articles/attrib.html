<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="attrib">
<title>Introduction to Attrib • attrib</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.5/font.css" rel="stylesheet">
<!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Attrib">
<meta property="og:description" content="attrib">
<meta property="og:image" content="https://www.csids.no/attrib/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><script data-goatcounter="https://csidsno.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    <a href="https://www.csids.no" class="external-link"><img src="https://www.csids.no/resources/logo/logo_full_white.svg" id="csidslogo"></a>
    <a class="navbar-brand me-2" href="../index.html">attrib</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2023.6.8</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/attrib.html">Get started</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/nowcast.html">Nowcasting with Attrib</a>
    <a class="dropdown-item" href="../articles/statistical_properties.html">Statistical properties used in Attrib</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">News</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://www.csids.no/">Home</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-packages">Packages</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-packages">
    <a class="external-link dropdown-item" href="https://www.csids.no/packages.html">Home</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>csverse</h6>
    <a class="dropdown-item" href="https://www.csids.no/attrib/">attrib</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/covidnor/">covidnor</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/csalert/">csalert</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/csdata/">csdata</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/csdb/">csdb</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/csmaps/">csmaps</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/csstyle/">csstyle</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/cstidy/">cstidy</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/cstime/">cstime</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/csutil/">csutil</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/nowcast/">nowcast</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/org/">org</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/plnr/">plnr</a>
    <a class="external-link dropdown-item" href="https://www.csids.no/sc9/">sc9</a>
  </div>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://www.csids.no/resources.html">Resources</a>
</li>
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/csids/attrib/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">

<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Introduction to Attrib</h1>
                        <h4 data-toc-skip class="author">Aurora Christine Hofman</h4>
            
            <h4 data-toc-skip class="date">2020-07-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/csids/attrib/blob/HEAD/vignettes/attrib.Rmd" class="external-link"><code>vignettes/attrib.Rmd</code></a></small>
      <div class="d-none name"><code>attrib.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.csids.no/attrib/">attrib</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; attrib 2023.6.8</span></span>
<span><span class="co">#&gt; https://www.csids.no/attrib/</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>attrib</code> provides a way of estimating what the mortality would have been if some given exposures are set to a reference value. By using simulations from the posterior distribution of all coefficients we can easily aggregate over time and locations while still estimating valid credible intervals.</p>
<p>This vignette will go through:</p>
<ul>
<li>how to use <code>fit_attrib</code> to fit the model to the data</li>
<li>how to use <code>est_attrib</code> to estimate the mortality under different scenarios (i.e. when the exposures are at reference values and at observed values)</li>
<li>some examples of usages of the resulting dataset</li>
</ul>
<div class="section level3">
<h3 id="data-example">Data example<a class="anchor" aria-label="anchor" href="#data-example"></a>
</h3>
<p>We will use the datasets <code>data_fake_attrib_county</code> and <code>data_fake_attrib_nation</code>.</p>
<p><code>data_fake_attrib_county</code> consists of fake mortality data for all counties of Norway on a weekly basis from 2010 until 2020. The dataset consists of the following features:</p>
<ul>
<li>location_code: Location code of the different counties</li>
<li>isoyear: Isoyear</li>
<li>isoweek: Week number</li>
<li>isoyearweek: Isoyear and isoweek</li>
<li>season: Years of the season</li>
<li>seasonweek: Number of weeks from the start of the season</li>
<li>pop_jan1_n: Population size</li>
<li>ili_isoweekmean0_6_pr100: Percentage of doctors consultations diagnosed with influenza like illnesses</li>
<li>ili_isoweekmean7_13_pr100: ili_isoweekmean0_6_pr100 lagged with one week</li>
<li>heatwavedays_n: number of heatwaves</li>
<li>deaths_n: number of deaths</li>
</ul>
<p><code>data_fake_attrib_nation</code> is a similar dataset at the national level.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_fake_county</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_attrib_county.html">data_fake_attrib_county</a></span></span>
<span><span class="va">data_fake_nation</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_attrib_nation.html">data_fake_attrib_nation</a></span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_fake_county</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt; 1:                0.9231202                 0.8146507              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                 1.7890927              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                 1.6017501              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                 0.7167721              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                 1.1638354              0      115</span></span></code></pre></div>
<p>In this example we will look at the exposures <code>ili_isoweekmean7_13_pr100</code> and <code>heatwavedays_n</code> and calculate the attributable mortality due to these exposures.</p>
</div>
</div>
<div class="section level2">
<h2 id="fitting-using-fit_attrib">Fitting using fit_attrib<a class="anchor" aria-label="anchor" href="#fitting-using-fit_attrib"></a>
</h2>
<div class="section level3">
<h3 id="county-level">County level<a class="anchor" aria-label="anchor" href="#county-level"></a>
</h3>
<p>We want to estimate the attributable mortality due to ILI and heatwaves. <code>attrib</code> lets us fit models with both fixed and random effect and offsets using linear mixed models (LMM).</p>
<p>We use the <code>glmer</code> function from the <code>lme4</code> package. In practice, this means we must specify the response, offsets, the fixed effects, and the random effects. In our case we will model the response <em>deaths</em> as a function of:</p>
<ul>
<li>the fixed effects:
<ul>
<li>heatwavedays_n</li>
<li>ili_isoweekmean7_13_pr100</li>
<li>sin(2 * pi * (isoweek - 1) / 52)</li>
<li>cos(2 * pi * (isoweek - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(1|location_code)</li>
<li>(ili_isoweekmean7_13_pr100|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop_jan1_n)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#response</span></span>
<span><span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"deaths_n"</span></span>
<span></span>
<span><span class="co"># fixed effects</span></span>
<span><span class="va">fixef_county</span> <span class="op">&lt;-</span> <span class="st">" heatwavedays_n +</span></span>
<span><span class="st">  ili_isoweekmean7_13_pr100 +</span></span>
<span><span class="st">  sin(2 * pi * (isoweek - 1) / 52) +</span></span>
<span><span class="st">  cos(2 * pi * (isoweek - 1) / 52)"</span></span>
<span></span>
<span></span>
<span><span class="co">#random effects</span></span>
<span><span class="va">ranef_county</span> <span class="op">&lt;-</span> <span class="st">"(1|location_code) +</span></span>
<span><span class="st">  (ili_isoweekmean7_13_pr100|season)"</span></span>
<span></span>
<span><span class="co">#offset</span></span>
<span><span class="va">offset_county</span> <span class="op">&lt;-</span> <span class="st">"log(pop_jan1_n)"</span></span>
<span></span>
<span><span class="co"># Now we fit the model using `fit_attrib`. </span></span>
<span><span class="va">fit_county</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_attrib.html">fit_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">data_fake_county</span>, </span>
<span>  response <span class="op">=</span> <span class="va">response</span>, </span>
<span>  fixef <span class="op">=</span> <span class="va">fixef_county</span>, </span>
<span>  ranef <span class="op">=</span> <span class="va">ranef_county</span>, </span>
<span>  offset <span class="op">=</span> <span class="va">offset_county</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This results in the following fit:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_county</span></span>
<span><span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span></span>
<span><span class="co">#&gt;   Approximation) [glmerMod]</span></span>
<span><span class="co">#&gt;  Family: poisson  ( log )</span></span>
<span><span class="co">#&gt; Formula: deaths_n ~ heatwavedays_n + ili_isoweekmean7_13_pr100 + sin(2 *  </span></span>
<span><span class="co">#&gt;     pi * (isoweek - 1)/52) + cos(2 * pi * (isoweek - 1)/52) +  </span></span>
<span><span class="co">#&gt;     offset(log(pop_jan1_n)) + (1 | location_code) + (ili_isoweekmean7_13_pr100 |  </span></span>
<span><span class="co">#&gt;     season)</span></span>
<span><span class="co">#&gt;    Data: data</span></span>
<span><span class="co">#&gt;       AIC       BIC    logLik  deviance  df.resid </span></span>
<span><span class="co">#&gt;  44402.03  44462.79 -22192.02  44384.03      6305 </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;  Groups        Name                      Std.Dev. Corr </span></span>
<span><span class="co">#&gt;  location_code (Intercept)               0.001725      </span></span>
<span><span class="co">#&gt;  season        (Intercept)               0.002016      </span></span>
<span><span class="co">#&gt;                ili_isoweekmean7_13_pr100 0.005003 -1.00</span></span>
<span><span class="co">#&gt; Number of obs: 6314, groups:  location_code, 11; season, 11</span></span>
<span><span class="co">#&gt; Fixed Effects:</span></span>
<span><span class="co">#&gt;                    (Intercept)                  heatwavedays_n  </span></span>
<span><span class="co">#&gt;                       -8.79945                         0.07321  </span></span>
<span><span class="co">#&gt;      ili_isoweekmean7_13_pr100  sin(2 * pi * (isoweek - 1)/52)  </span></span>
<span><span class="co">#&gt;                        0.03429                         0.01448  </span></span>
<span><span class="co">#&gt; cos(2 * pi * (isoweek - 1)/52)  </span></span>
<span><span class="co">#&gt;                        0.06784  </span></span>
<span><span class="co">#&gt; optimizer (Nelder_Mead) convergence code: 0 (OK) ; 0 optimizer warnings; 1 lme4 warnings</span></span></code></pre></div>
<p>Note that fit has the added attributes <code>offset</code> (saving the offset name) and <code>fit_fix</code> (the coefficients of the linear model fitted on only the fixed effects). These are needed by <code>est_attrib</code> to create the dataset containing only the fixed effects.</p>
</div>
<div class="section level3">
<h3 id="national-level">National level<a class="anchor" aria-label="anchor" href="#national-level"></a>
</h3>
<p>We estimate the same as before But on a national level, meaning we remove the random effect (1|location_code) since we only have one location code. This gives the following features:</p>
<ul>
<li>the fixed effects:
<ul>
<li>heatwavedays_n</li>
<li>ili_isoweekmean7_13_pr100</li>
<li>sin(2 * pi * (isoweek - 1) / 52)</li>
<li>cos(2 * pi * (isoweek - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(ili_isoweekmean7_13_pr100|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop_jan1_n)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#response</span></span>
<span><span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"deaths_n"</span></span>
<span></span>
<span><span class="co"># fixed effects</span></span>
<span><span class="va">fixef_nation</span> <span class="op">&lt;-</span> <span class="st">" heatwavedays_n +</span></span>
<span><span class="st">  ili_isoweekmean7_13_pr100 +</span></span>
<span><span class="st">  sin(2 * pi * (isoweek - 1) / 52) +</span></span>
<span><span class="st">  cos(2 * pi * (isoweek - 1) / 52)"</span></span>
<span></span>
<span></span>
<span><span class="co">#random effects</span></span>
<span><span class="va">ranef_nation</span> <span class="op">&lt;-</span> <span class="st">"(ili_isoweekmean7_13_pr100|season)"</span></span>
<span></span>
<span><span class="co">#offset</span></span>
<span><span class="va">offset_nation</span> <span class="op">&lt;-</span> <span class="st">"log(pop_jan1_n)"</span></span>
<span></span>
<span><span class="co"># Now we fit the model using `fit_attrib`. </span></span>
<span><span class="va">fit_nation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_attrib.html">fit_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">data_fake_nation</span>, </span>
<span>  response <span class="op">=</span> <span class="va">response</span>, </span>
<span>  fixef <span class="op">=</span> <span class="va">fixef_nation</span>, </span>
<span>  ranef <span class="op">=</span> <span class="va">ranef_nation</span>, </span>
<span>  offset <span class="op">=</span> <span class="va">offset_nation</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="using-the-sim-function">Using the sim function<a class="anchor" aria-label="anchor" href="#using-the-sim-function"></a>
</h2>
<p>The <code>sim</code> function can be used to generate simulations for all the rows in our data.</p>
<p>It first generates <code>n_sim</code> simulations from the posterior distribution of the coefficients from out fit before applying these coefficients on our dataset generating <code>n_sim</code> simulations and expected mortality for each line. This is quite generic. Hence if the goal is to compute attributable mortality or incident risk ratios we use <code>est_attrib</code> as shown in a later part of the vignette.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim.html">sim</a></span><span class="op">(</span><span class="va">fit_nation</span>, <span class="va">data_fake_nation</span>, <span class="va">n_sim</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">[</span><span class="va">id_row</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt; 1:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 2:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 3:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 4:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt; 5:    nation_nor    2009      30     2009-30 2009/2010          1    5367580</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt; 1:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 2:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 3:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 4:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt; 5:              8.98914e-07                         0      0.8181818      827</span></span>
<span><span class="co">#&gt;    id_row sim_id sim_value</span></span>
<span><span class="co">#&gt; 1:      1      1  807.3156</span></span>
<span><span class="co">#&gt; 2:      1      2  810.0678</span></span>
<span><span class="co">#&gt; 3:      1      3  802.7396</span></span>
<span><span class="co">#&gt; 4:      1      4  803.5876</span></span>
<span><span class="co">#&gt; 5:      1      5  805.2850</span></span></code></pre></div>
<p>We can see that we now have multiple expected mortalities for the same dataline. This is due to the coefficient simulations.</p>
</div>
<div class="section level2">
<h2 id="estimating-attributable-mortality-using-est_attrib">Estimating attributable mortality using est_attrib<a class="anchor" aria-label="anchor" href="#estimating-attributable-mortality-using-est_attrib"></a>
</h2>
<p>To estimate attributable mortality we simulate:</p>
<ul>
<li>the estimated mortality for observed exposures</li>
<li>the estimated mortality for the exposures set to reference values</li>
</ul>
<p>This is easily done using <code>est_attrib</code>.</p>
<p>We need to give the fit, the dataset, the exposures with reference values, and the number of simulations. <code>est_attrib</code> will then using the <code><a href="https://rdrr.io/pkg/arm/man/sim.html" class="external-link">arm::sim</a></code> function to generate simulations of the underlying posterior distribution. <code><a href="../reference/sim.html">attrib::sim</a></code> will then combine the simulated coefficients to estimate the modeled outcome (i.e. number of deaths) for each simulation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="st">"heatwavedays_n"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"ili_isoweekmean7_13_pr100"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">est_attrib_sim_county</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_county</span>, </span>
<span>  <span class="va">data_fake_county</span>, </span>
<span>  exposures <span class="op">=</span> <span class="va">exposures</span>, </span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">est_attrib_sim_nation</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_nation</span>, </span>
<span>  <span class="va">data_fake_nation</span>, </span>
<span>  exposures <span class="op">=</span> <span class="va">exposures</span>,</span>
<span>  n_sim <span class="op">=</span> <span class="va">n_sim</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_sim_county</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt; 1:                0.9231202                 0.8146507              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                 1.7890927              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                 1.6017501              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                 0.7167721              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                 1.1638354              0      115</span></span>
<span><span class="co">#&gt;    id sim_id sim_value_exposures=observed sim_value_heatwavedays_n=0</span></span>
<span><span class="co">#&gt; 1:  1      1                     114.2379                   114.2379</span></span>
<span><span class="co">#&gt; 2:  2      1                     117.9895                   117.9895</span></span>
<span><span class="co">#&gt; 3:  3      1                     117.1525                   117.1525</span></span>
<span><span class="co">#&gt; 4:  4      1                     114.7316                   114.7316</span></span>
<span><span class="co">#&gt; 5:  5      1                     117.5407                   117.5407</span></span>
<span><span class="co">#&gt;    sim_value_ili_isoweekmean7_13_pr100=0</span></span>
<span><span class="co">#&gt; 1:                              111.9369</span></span>
<span><span class="co">#&gt; 2:                              113.1031</span></span>
<span><span class="co">#&gt; 3:                              112.3154</span></span>
<span><span class="co">#&gt; 4:                              112.8651</span></span>
<span><span class="co">#&gt; 5:                              113.4813</span></span></code></pre></div>
<p>We can see in the above dataset that the columns <em>id</em>, <em>sim_id</em>, <em>sim_value_exposures=observed</em>, <em>sim_value_heatwavedays_n=0</em>, <em>sim_value_ili_isoweekmean7_13_pr100=0</em> are added to the previous set of columns. For each row in the original dataset we now have 20 <!-- change this if we change n_sim --> rows, one for each of the simulations done by est_attrib. In each row we see the estimate of the number of deaths given a reference value for <em>sim_value_heatwavedays_n</em> and <em>sim_value_ili_isoweekmean7_13_pr100</em>.</p>
<p>To make the data processing easier later we convert the dataset from wide to long form and collapse the estimated mortality</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_attrib_county_long</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt.data.table</a></span><span class="op">(</span></span>
<span>  <span class="va">est_attrib_sim_county</span>, </span>
<span>  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"location_code"</span>, </span>
<span>    <span class="st">"isoyear"</span>,</span>
<span>    <span class="st">"isoweek"</span>,</span>
<span>    <span class="st">"isoyearweek"</span>,</span>
<span>    <span class="st">"season"</span>,  </span>
<span>    <span class="st">"seasonweek"</span>, </span>
<span>    <span class="st">"id"</span>, </span>
<span>    <span class="st">"sim_id"</span>, </span>
<span>    <span class="st">"deaths_n"</span>, </span>
<span>    <span class="st">"sim_value_exposures=observed"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"sim_value_heatwavedays_n=0"</span>, </span>
<span>    <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">est_attrib_county_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_county_long</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek id sim_id</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24  1      1</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24  2      1</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24  3      1</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24  4      1</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24  5      1</span></span>
<span><span class="co">#&gt;    deaths_n sim_value_exposures=observed                       attr    value</span></span>
<span><span class="co">#&gt; 1:      112                     114.2379 sim_value_heatwavedays_n=0 114.2379</span></span>
<span><span class="co">#&gt; 2:      113                     117.9895 sim_value_heatwavedays_n=0 117.9895</span></span>
<span><span class="co">#&gt; 3:      128                     117.1525 sim_value_heatwavedays_n=0 117.1525</span></span>
<span><span class="co">#&gt; 4:      126                     114.7316 sim_value_heatwavedays_n=0 114.7316</span></span>
<span><span class="co">#&gt; 5:      115                     117.5407 sim_value_heatwavedays_n=0 117.5407</span></span></code></pre></div>
<p>We can see that the columns <em>sim_value_heatwavedays_n=0</em>, <em>sim_value_ili_isoweekmean7_13_pr100=0</em> are now collapsed into the new column <em>attr</em> and <em>value</em> with <em>attr</em> describing which exposure we have and <em>value</em> giving the corresponding reference value.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_attrib_nation_long</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html" class="external-link">melt.data.table</a></span><span class="op">(</span></span>
<span>  <span class="va">est_attrib_sim_nation</span>, </span>
<span>  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"location_code"</span>, </span>
<span>    <span class="st">"isoyear"</span>,</span>
<span>    <span class="st">"isoweek"</span>,</span>
<span>    <span class="st">"isoyearweek"</span>,</span>
<span>    <span class="st">"season"</span>,  </span>
<span>    <span class="st">"seasonweek"</span>, </span>
<span>    <span class="st">"id"</span>, </span>
<span>    <span class="st">"sim_id"</span>, </span>
<span>    <span class="st">"deaths_n"</span>, </span>
<span>    <span class="st">"sim_value_exposures=observed"</span></span>
<span>  <span class="op">)</span>,</span>
<span>  measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"sim_value_heatwavedays_n=0"</span>, </span>
<span>    <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">est_attrib_nation_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_nation_long</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek id sim_id</span></span>
<span><span class="co">#&gt; 1:    nation_nor    2009      30     2009-30 2009/2010          1  1      1</span></span>
<span><span class="co">#&gt; 2:    nation_nor    2009      31     2009-31 2009/2010          2  2      1</span></span>
<span><span class="co">#&gt; 3:    nation_nor    2009      32     2009-32 2009/2010          3  3      1</span></span>
<span><span class="co">#&gt; 4:    nation_nor    2009      33     2009-33 2009/2010          4  4      1</span></span>
<span><span class="co">#&gt; 5:    nation_nor    2009      34     2009-34 2009/2010          5  5      1</span></span>
<span><span class="co">#&gt;    deaths_n sim_value_exposures=observed                       attr    value</span></span>
<span><span class="co">#&gt; 1:      827                     808.3530 sim_value_heatwavedays_n=0 761.6070</span></span>
<span><span class="co">#&gt; 2:      751                     794.0040 sim_value_heatwavedays_n=0 763.0903</span></span>
<span><span class="co">#&gt; 3:      811                     785.7890 sim_value_heatwavedays_n=0 765.2585</span></span>
<span><span class="co">#&gt; 4:      787                     799.2017 sim_value_heatwavedays_n=0 768.0857</span></span>
<span><span class="co">#&gt; 5:      828                     792.2368 sim_value_heatwavedays_n=0 771.5378</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="compare-the-national-data-to-data-aggregated-from-county-to-national-level-">Compare the national data to data aggregated from county to national level.<a class="anchor" aria-label="anchor" href="#compare-the-national-data-to-data-aggregated-from-county-to-national-level-"></a>
</h2>
<p>We will now aggregate our two simulated datasets (one on a county level and one on a national level) to aid in comparison.</p>
<div class="section level3">
<h3 id="aggregate-from-countyweekly-to-nationalseasonal">Aggregate from county/weekly to national/seasonal<a class="anchor" aria-label="anchor" href="#aggregate-from-countyweekly-to-nationalseasonal"></a>
</h3>
<p>We proceed by aggregating the county dataset to the national/seasonal level. Afterwards we calculate the expected attributable mortality, <code>exp_attr</code>, by subtracting <code>value</code> (the simulated expected number of deaths given the reference value of the exposure) from <em>the sim_value_exposures=observed</em>.</p>
<p>To be able to separate this dataset from the other we add a tag.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_county_long</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Add exp_attr, exp_irr and a tag.</span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"aggregated_from_county"</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;       season                       attr sim_id sim_value_exposures=observed</span></span>
<span><span class="co">#&gt; 1: 2009/2010 sim_value_heatwavedays_n=0      1                     43768.73</span></span>
<span><span class="co">#&gt; 2: 2009/2010 sim_value_heatwavedays_n=0      2                     44070.95</span></span>
<span><span class="co">#&gt; 3: 2009/2010 sim_value_heatwavedays_n=0      3                     44455.71</span></span>
<span><span class="co">#&gt; 4: 2009/2010 sim_value_heatwavedays_n=0      4                     44195.52</span></span>
<span><span class="co">#&gt; 5: 2009/2010 sim_value_heatwavedays_n=0      5                     44709.98</span></span>
<span><span class="co">#&gt;       value deaths_n exp_attr                    tag</span></span>
<span><span class="co">#&gt; 1: 43355.27    44006 413.4645 aggregated_from_county</span></span>
<span><span class="co">#&gt; 2: 43670.21    44006 400.7446 aggregated_from_county</span></span>
<span><span class="co">#&gt; 3: 44023.37    44006 432.3361 aggregated_from_county</span></span>
<span><span class="co">#&gt; 4: 43801.03    44006 394.4844 aggregated_from_county</span></span>
<span><span class="co">#&gt; 5: 44267.72    44006 442.2571 aggregated_from_county</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="aggregating-the-national-model-per-season">Aggregating the national model per season<a class="anchor" aria-label="anchor" href="#aggregating-the-national-model-per-season"></a>
</h3>
<p>For the national model we aggregate over seasons and create exp_attr in the same way as above.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_nation_long</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">aggregated_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_nation</span><span class="op">[</span>, <span class="va">tag</span><span class="op">:=</span> <span class="st">"nation"</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_nation</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;       season                       attr sim_id sim_value_exposures=observed</span></span>
<span><span class="co">#&gt; 1: 2009/2010 sim_value_heatwavedays_n=0      1                     44484.64</span></span>
<span><span class="co">#&gt; 2: 2009/2010 sim_value_heatwavedays_n=0      2                     44297.66</span></span>
<span><span class="co">#&gt; 3: 2009/2010 sim_value_heatwavedays_n=0      3                     43880.36</span></span>
<span><span class="co">#&gt; 4: 2009/2010 sim_value_heatwavedays_n=0      4                     44188.17</span></span>
<span><span class="co">#&gt; 5: 2009/2010 sim_value_heatwavedays_n=0      5                     44156.80</span></span>
<span><span class="co">#&gt;       value deaths_n exp_attr    tag</span></span>
<span><span class="co">#&gt; 1: 44076.80    44006 407.8435 nation</span></span>
<span><span class="co">#&gt; 2: 43797.77    44006 499.8873 nation</span></span>
<span><span class="co">#&gt; 3: 43435.57    44006 444.7890 nation</span></span>
<span><span class="co">#&gt; 4: 43636.87    44006 551.2955 nation</span></span>
<span><span class="co">#&gt; 5: 43733.17    44006 423.6221 nation</span></span></code></pre></div>
<p>For simplicity we <code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">data.table::rbindlist</a></code> the two datasets together.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">data_national</span><span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="va">aggregated_nation</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="calculate-simulation-quantiles-">Calculate simulation quantiles.<a class="anchor" aria-label="anchor" href="#calculate-simulation-quantiles-"></a>
</h3>
<p>The next thing to do is to aggregate away the simulations. The benefits of having the simulations is the possibility it gives to efficiently compute all desired quantiles. For this example we will use the .05, .5 and .95 quantiles.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Quantile functins</span></span>
<span><span class="va">q025</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.025</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">q975</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We compute the quantiles for <em>exp_attr</em> in the following way.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">data_national</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkeyv</a></span><span class="op">(</span></span>
<span>  <span class="va">data_national</span>, </span>
<span>  <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"exp_attr"</span>, </span>
<span>    <span class="st">"sim_id"</span>, </span>
<span>    <span class="st">"sim_value_exposures=observed"</span>, </span>
<span>    <span class="st">"value"</span>, </span>
<span>    <span class="st">"deaths_n"</span></span>
<span>  <span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggregated_sim_seasonal_data_national</span><span class="op">&lt;-</span> <span class="va">data_national</span><span class="op">[</span></span>
<span>  ,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span></span>
<span>    recursive <span class="op">=</span> <span class="cn">FALSE</span>, </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span>, </span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">key</a></span><span class="op">(</span><span class="va">data_national</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_sim_seasonal_data_national</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;       season                                  attr                    tag</span></span>
<span><span class="co">#&gt; 1: 2009/2010            sim_value_heatwavedays_n=0 aggregated_from_county</span></span>
<span><span class="co">#&gt; 2: 2009/2010            sim_value_heatwavedays_n=0                 nation</span></span>
<span><span class="co">#&gt; 3: 2009/2010 sim_value_ili_isoweekmean7_13_pr100=0 aggregated_from_county</span></span>
<span><span class="co">#&gt; 4: 2009/2010 sim_value_ili_isoweekmean7_13_pr100=0                 nation</span></span>
<span><span class="co">#&gt; 5: 2010/2011            sim_value_heatwavedays_n=0 aggregated_from_county</span></span>
<span><span class="co">#&gt;    median.exp_attr q025.exp_attr q975.exp_attr</span></span>
<span><span class="co">#&gt; 1:        412.6411      390.4961      442.6492</span></span>
<span><span class="co">#&gt; 2:        471.0203      365.0025      534.5972</span></span>
<span><span class="co">#&gt; 3:        711.2374      555.2749      836.0516</span></span>
<span><span class="co">#&gt; 4:        733.5690      512.9498      972.1955</span></span>
<span><span class="co">#&gt; 5:        468.3495      437.6797      495.9044</span></span></code></pre></div>
<p>We can now see that we have credible intervals and estimates for attributable deaths for all exposures.</p>
</div>
<div class="section level3">
<h3 id="plot-to-compare-the-national-with-the-aggregated-county-to-national-model">Plot to compare the national with the aggregated county to national model<a class="anchor" aria-label="anchor" href="#plot-to-compare-the-national-with-the-aggregated-county-to-national-model"></a>
</h3>
<p>To be able to compare the two models we make a point range plot using ggplot2.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  <span class="va">aggregated_sim_seasonal_data_national</span><span class="op">[</span><span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">]</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">season</span>, y <span class="op">=</span> <span class="va">median.exp_attr</span>, group <span class="op">=</span> <span class="va">tag</span>, color <span class="op">=</span> <span class="va">tag</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">season</span>, y <span class="op">=</span> <span class="va">median.exp_attr</span>, ymin <span class="op">=</span> <span class="va">q025.exp_attr</span>, ymax <span class="op">=</span> <span class="va">q975.exp_attr</span><span class="op">)</span>, </span>
<span>  position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Attributable mortality due to ILI in Norway according to 2 models"</span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated attributable mortality"</span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>caption <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"Aggregated county model: Attributable mortality modeled on a county level before beeing aggregated up to a national level.\n National model: Attributable mortality modeled on a national level."</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-15-1.png" width="576"></p>
</div>
</div>
<div class="section level2">
<h2 id="comparing-cumulative-sums-over-seasons">Comparing cumulative sums over seasons<a class="anchor" aria-label="anchor" href="#comparing-cumulative-sums-over-seasons"></a>
</h2>
<p>When operating on the national level, we prefer to aggregate the county model to national level (instead of using the national model). This ensures consistent results at all geographical levels.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_county_long</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">seasonweek</span>, <span class="va">isoweek</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_irr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">/</span><span class="va">value</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;       season seasonweek isoweek                       attr sim_id</span></span>
<span><span class="co">#&gt; 1: 2009/2010          1      30 sim_value_heatwavedays_n=0      1</span></span>
<span><span class="co">#&gt; 2: 2009/2010          1      30 sim_value_heatwavedays_n=0      2</span></span>
<span><span class="co">#&gt; 3: 2009/2010          1      30 sim_value_heatwavedays_n=0      3</span></span>
<span><span class="co">#&gt; 4: 2009/2010          1      30 sim_value_heatwavedays_n=0      4</span></span>
<span><span class="co">#&gt; 5: 2009/2010          1      30 sim_value_heatwavedays_n=0      5</span></span>
<span><span class="co">#&gt;    sim_value_exposures=observed    value deaths_n exp_attr  exp_irr</span></span>
<span><span class="co">#&gt; 1:                     786.3562 747.5979      827 38.75835 1.051844</span></span>
<span><span class="co">#&gt; 2:                     794.6368 757.0525      827 37.58435 1.049646</span></span>
<span><span class="co">#&gt; 3:                     803.1978 762.6508      827 40.54697 1.053166</span></span>
<span><span class="co">#&gt; 4:                     791.2099 754.2325      827 36.97745 1.049027</span></span>
<span><span class="co">#&gt; 5:                     806.7873 765.1923      827 41.59499 1.054359</span></span></code></pre></div>
<p>Again we compute the quantiles.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkeyv</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span>,<span class="st">"sim_id"</span>, <span class="st">"exposures"</span>, <span class="st">"sim_value_exposures=observed"</span>, <span class="st">"value"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation_weekly</span> <span class="op">&lt;-</span> <span class="va">aggregated_county_to_nation</span><span class="op">[</span>,</span>
<span>              <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>,</span>
<span>                                               <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span></span>
<span>              <span class="op">)</span><span class="op">)</span>, </span>
<span>              by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">key</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We then estimate the cumulative sums of attributable mortality and corresponding credible intervals.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">median.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum_q025</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">q025.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum_q975</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html" class="external-link">cumsum</a></span><span class="op">(</span><span class="va">q975.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_weekly</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;       season seasonweek isoweek                                  attr deaths_n</span></span>
<span><span class="co">#&gt; 1: 2009/2010          1      30            sim_value_heatwavedays_n=0      827</span></span>
<span><span class="co">#&gt; 2: 2009/2010          1      30 sim_value_ili_isoweekmean7_13_pr100=0      827</span></span>
<span><span class="co">#&gt; 3: 2009/2010          2      31            sim_value_heatwavedays_n=0      751</span></span>
<span><span class="co">#&gt; 4: 2009/2010          2      31 sim_value_ili_isoweekmean7_13_pr100=0      751</span></span>
<span><span class="co">#&gt; 5: 2009/2010          3      32            sim_value_heatwavedays_n=0      811</span></span>
<span><span class="co">#&gt;    median.exp_attr median.exp_irr q025.exp_attr q025.exp_irr q975.exp_attr</span></span>
<span><span class="co">#&gt; 1:    3.869028e+01       1.051496  3.661640e+01     1.048323  4.157655e+01</span></span>
<span><span class="co">#&gt; 2:    0.000000e+00       1.000000  0.000000e+00     1.000000  0.000000e+00</span></span>
<span><span class="co">#&gt; 3:    2.645599e+01       1.035102  2.510310e+01     1.033077  2.833190e+01</span></span>
<span><span class="co">#&gt; 4:    1.786682e-05       1.000000  1.403088e-05     1.000000  2.112109e-05</span></span>
<span><span class="co">#&gt; 5:    2.168157e+01       1.028680  2.051557e+01     1.026964  2.322068e+01</span></span>
<span><span class="co">#&gt;    q975.exp_irr       cumsum  cumsum_q025  cumsum_q975</span></span>
<span><span class="co">#&gt; 1:     1.054744 3.869028e+01 3.661640e+01 4.157655e+01</span></span>
<span><span class="co">#&gt; 2:     1.000000 0.000000e+00 0.000000e+00 0.000000e+00</span></span>
<span><span class="co">#&gt; 3:     1.037239 6.514627e+01 6.171950e+01 6.990845e+01</span></span>
<span><span class="co">#&gt; 4:     1.000000 1.786682e-05 1.403088e-05 2.112109e-05</span></span>
<span><span class="co">#&gt; 5:     1.030436 8.682784e+01 8.223507e+01 9.312912e+01</span></span></code></pre></div>
<p>We can then plot the estimated cumulative attributable mortality over influenza seasons in Norway</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"2015/2016"</span>,</span>
<span>      <span class="st">"2016/2017"</span>,</span>
<span>      <span class="st">"2017/2018"</span>,</span>
<span>      <span class="st">"2018/2019"</span>,</span>
<span>      <span class="st">"2019/2020"</span></span>
<span>    <span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>, </span>
<span>    y <span class="op">=</span> <span class="va">cumsum</span>, </span>
<span>    group <span class="op">=</span> <span class="va">season</span>, </span>
<span>    color <span class="op">=</span> <span class="va">season</span>, </span>
<span>    fill <span class="op">=</span> <span class="va">season</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2019/2020"</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    ymin <span class="op">=</span> <span class="va">cumsum_q025</span>, </span>
<span>    ymax <span class="op">=</span> <span class="va">cumsum_q975</span></span>
<span>  <span class="op">)</span>, </span>
<span>  alpha <span class="op">=</span> <span class="fl">0.4</span>, </span>
<span>  colour <span class="op">=</span> <span class="cn">NA</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated cumulative attributable mortality"</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Estimated cumulative attributable mortality over influenza seasons in Norway"</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-19-1.png" width="576"></p>
<p>We can also plot the estimated weekly attributable mortality in Norway</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span><span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">]</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">seasonweek</span>, y <span class="op">=</span> <span class="va">cumsum</span>, group <span class="op">=</span> <span class="va">season</span><span class="op">)</span></span>
<span>  <span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op">!=</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>, </span>
<span>    y <span class="op">=</span> <span class="va">median.exp_attr</span>, </span>
<span>    group <span class="op">=</span> <span class="va">season</span></span>
<span>  <span class="op">)</span>, </span>
<span>  color <span class="op">=</span> <span class="st">"grey"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op">==</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>,</span>
<span>    y <span class="op">=</span> <span class="va">median.exp_attr</span>,</span>
<span>    group <span class="op">=</span> <span class="va">season</span></span>
<span>  <span class="op">)</span>, </span>
<span>  color <span class="op">=</span> <span class="st">"blue"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span></span>
<span>    <span class="va">season</span> <span class="op">==</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span></span>
<span>    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span></span>
<span>  <span class="op">]</span>,</span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">seasonweek</span>,</span>
<span>    ymin <span class="op">=</span> <span class="va">q025.exp_attr</span>,</span>
<span>    ymax <span class="op">=</span> <span class="va">q975.exp_attr</span></span>
<span>  <span class="op">)</span>,</span>
<span>  fill <span class="op">=</span> <span class="st">"blue"</span>,</span>
<span>  alpha<span class="op">=</span><span class="fl">0.4</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated attributable mortality"</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Estimated mortality due to ILI per week"</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="incident-rate-ratio">Incident rate ratio<a class="anchor" aria-label="anchor" href="#incident-rate-ratio"></a>
</h2>
<p>Until now we have focused on estimating attributable mortality. Now we will investigate computing the incident rate ratio (IRR) for <em>ili_isoweekmean7_13_pr100</em>. To do this we will use the fit made by <code>fit_attrib</code> on the county dataset but we will change the values for <em>ili_isoweekmean7_13_pr100</em> to 1 (IRRs are generally expressed as the effect of the exposure changing from 0 to 1).</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_fake_county_irr</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html" class="external-link">copy</a></span><span class="op">(</span><span class="va">data_fake_county</span><span class="op">)</span></span>
<span><span class="va">data_fake_county_irr</span><span class="op">[</span>, <span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_fake_county_irr</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt; 1:                0.9231202                         1              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                         1              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                         1              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                         1              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                         1              0      115</span></span></code></pre></div>
<p>Then we can set the reference value to zero and hence obtain the IRR for the given exposure.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exposures_irr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>ili_isoweekmean7_13_pr100 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></span></code></pre></div>
<p>Now we use <code>est_attrib</code> to create the simulations.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">est_attrib_sim_county_irr</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_county</span>, </span>
<span>  <span class="va">data_fake_county_irr</span>, </span>
<span>  exposures <span class="op">=</span> <span class="va">exposures_irr</span>,</span>
<span>  n_sim <span class="op">=</span> <span class="fl">100</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">est_attrib_sim_county_irr</span>, <span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;    location_code isoyear isoweek isoyearweek    season seasonweek pop_jan1_n</span></span>
<span><span class="co">#&gt; 1:  county_nor03    2010       1     2010-01 2009/2010         24     693494</span></span>
<span><span class="co">#&gt; 2:  county_nor03    2011       1     2011-01 2010/2011         24     693494</span></span>
<span><span class="co">#&gt; 3:  county_nor03    2012       1     2012-01 2011/2012         24     693494</span></span>
<span><span class="co">#&gt; 4:  county_nor03    2013       1     2013-01 2012/2013         24     693494</span></span>
<span><span class="co">#&gt; 5:  county_nor03    2014       1     2014-01 2013/2014         24     693494</span></span>
<span><span class="co">#&gt;    ili_isoweekmean0_6_pr100 ili_isoweekmean7_13_pr100 heatwavedays_n deaths_n</span></span>
<span><span class="co">#&gt; 1:                0.9231202                         1              0      112</span></span>
<span><span class="co">#&gt; 2:                1.8997241                         1              0      113</span></span>
<span><span class="co">#&gt; 3:                1.3924947                         1              0      128</span></span>
<span><span class="co">#&gt; 4:                0.9296033                         1              0      126</span></span>
<span><span class="co">#&gt; 5:                1.3933639                         1              0      115</span></span>
<span><span class="co">#&gt;    id sim_id sim_value_exposures=observed sim_value_ili_isoweekmean7_13_pr100=0</span></span>
<span><span class="co">#&gt; 1:  1      1                     115.0372                              111.4212</span></span>
<span><span class="co">#&gt; 2:  2      1                     116.8059                              113.2856</span></span>
<span><span class="co">#&gt; 3:  3      1                     117.3511                              113.5094</span></span>
<span><span class="co">#&gt; 4:  4      1                     115.0757                              111.6920</span></span>
<span><span class="co">#&gt; 5:  5      1                     115.8099                              111.5854</span></span></code></pre></div>
<p>We see we have obtained values for the reference of the exposure in the same way as before. The difference is that we changed the dataset before running <em>est_attrib</em>. This means we will now be observing the difference between <code>ili_isoweekmean7_13_pr100=0</code> and <code>ili_isoweekmean7_13_pr100=1</code>.</p>
<p>We now aggregate to the national seasonal level.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation_sim_irr</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_sim_county_irr</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span></span>
<span>  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,</span>
<span>  <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">`sim_value_ili_isoweekmean7_13_pr100=0`</span><span class="op">)</span>, </span>
<span>  deaths_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">deaths_n</span><span class="op">)</span></span>
<span><span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>Here we generate the IRR:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">[</span>, <span class="va">exp_irr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">/</span><span class="va">`sim_value_ili_isoweekmean7_13_pr100=0`</span></span>
<span><span class="op">)</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span>,<span class="fl">5</span><span class="op">)</span></span>
<span><span class="co">#&gt;       season sim_id sim_value_exposures=observed</span></span>
<span><span class="co">#&gt; 1: 2009/2010      1                     44601.63</span></span>
<span><span class="co">#&gt; 2: 2009/2010      2                     44623.96</span></span>
<span><span class="co">#&gt; 3: 2009/2010      3                     44827.63</span></span>
<span><span class="co">#&gt; 4: 2009/2010      4                     45239.76</span></span>
<span><span class="co">#&gt; 5: 2009/2010      5                     44872.28</span></span>
<span><span class="co">#&gt;    sim_value_ili_isoweekmean7_13_pr100=0 deaths_n  exp_irr</span></span>
<span><span class="co">#&gt; 1:                              43199.65    44006 1.032453</span></span>
<span><span class="co">#&gt; 2:                              43345.84    44006 1.029486</span></span>
<span><span class="co">#&gt; 3:                              43352.20    44006 1.034034</span></span>
<span><span class="co">#&gt; 4:                              43586.40    44006 1.037933</span></span>
<span><span class="co">#&gt; 5:                              43385.19    44006 1.034276</span></span></code></pre></div>
<p>Now we can compute the quantiles:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">)</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkeyv</a></span><span class="op">(</span></span>
<span>  <span class="va">aggregated_county_to_nation_sim_irr</span>,</span>
<span>  <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_irr"</span>, <span class="st">"sim_id"</span>, <span class="st">"sim_value_exposures=observed"</span>, <span class="st">"sim_value_ili_isoweekmean7_13_pr100=0"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation_irr</span> <span class="op">&lt;-</span> <span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">[</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">key</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"exp_irr"</span><span class="op">)</span></span>
<span><span class="op">]</span></span>
<span><span class="va">aggregated_county_to_nation_irr</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"aggregated"</span><span class="op">]</span></span>
<span></span>
<span><span class="va">aggregated_county_to_nation_irr</span></span>
<span><span class="co">#&gt;        season deaths_n median.exp_irr q025.exp_irr q975.exp_irr        tag</span></span>
<span><span class="co">#&gt;  1: 2009/2010    44006       1.034434     1.024874     1.042590 aggregated</span></span>
<span><span class="co">#&gt;  2: 2010/2011    43316       1.033053     1.023506     1.041198 aggregated</span></span>
<span><span class="co">#&gt;  3: 2011/2012    43221       1.035828     1.026256     1.043996 aggregated</span></span>
<span><span class="co">#&gt;  4: 2012/2013    43020       1.032271     1.022731     1.040410 aggregated</span></span>
<span><span class="co">#&gt;  5: 2013/2014    43309       1.039849     1.030240     1.048048 aggregated</span></span>
<span><span class="co">#&gt;  6: 2014/2015    43234       1.032363     1.022822     1.040503 aggregated</span></span>
<span><span class="co">#&gt;  7: 2015/2016    44320       1.038316     1.028721     1.046503 aggregated</span></span>
<span><span class="co">#&gt;  8: 2016/2017    43468       1.032752     1.023208     1.040895 aggregated</span></span>
<span><span class="co">#&gt;  9: 2017/2018    43438       1.039011     1.029409     1.047204 aggregated</span></span>
<span><span class="co">#&gt; 10: 2018/2019    43350       1.030513     1.020990     1.038639 aggregated</span></span>
<span><span class="co">#&gt; 11: 2019/2020    43707       1.035991     1.026417     1.044160 aggregated</span></span></code></pre></div>
<p>Now we compare the resulting values for IRR with the ones obtained by <code>coef(fit_county)$season</code> and the 90 percent credible interval computed manually using the standard deviation given by summary(fit_county) for <em>ili_isoweekmean7_13_pr100</em>.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coef_fit_county</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html" class="external-link">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_county</span><span class="op">)</span><span class="op">$</span><span class="va">season</span><span class="op">)</span></span>
<span><span class="va">col_names_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ili_isoweekmean7_13_pr100"</span><span class="op">)</span></span>
<span><span class="va">coef_irr_data</span> <span class="op">&lt;-</span> <span class="va">coef_fit_county</span><span class="op">[</span>, <span class="va">..col_names_coef</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">irr</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ili_isoweekmean7_13_pr100</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">q025</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span><span class="fl">0.003761</span><span class="op">)</span><span class="op">]</span>  <span class="co"># 0.003761 is the standard deviation from coef(fit_county)</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">q975</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span><span class="fl">0.003761</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"from_coef"</span><span class="op">]</span></span>
<span><span class="va">coef_irr_data</span></span>
<span><span class="co">#&gt;     ili_isoweekmean7_13_pr100      irr     q025     q975       tag</span></span>
<span><span class="co">#&gt;  1:                0.03380077 1.034379 1.026782 1.042032 from_coef</span></span>
<span><span class="co">#&gt;  2:                0.03246441 1.032997 1.025410 1.040640 from_coef</span></span>
<span><span class="co">#&gt;  3:                0.03514786 1.035773 1.028166 1.043436 from_coef</span></span>
<span><span class="co">#&gt;  4:                0.03170748 1.032216 1.024634 1.039853 from_coef</span></span>
<span><span class="co">#&gt;  5:                0.03902228 1.039794 1.032157 1.047487 from_coef</span></span>
<span><span class="co">#&gt;  6:                0.03179648 1.032307 1.024726 1.039945 from_coef</span></span>
<span><span class="co">#&gt;  7:                0.03754698 1.038261 1.030635 1.045943 from_coef</span></span>
<span><span class="co">#&gt;  8:                0.03217375 1.032697 1.025112 1.040338 from_coef</span></span>
<span><span class="co">#&gt;  9:                0.03821602 1.038956 1.031325 1.046643 from_coef</span></span>
<span><span class="co">#&gt; 10:                0.03000346 1.030458 1.022890 1.038082 from_coef</span></span>
<span><span class="co">#&gt; 11:                0.03530514 1.035936 1.028327 1.043600 from_coef</span></span></code></pre></div>
<p>Add the correct seasons to the data.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coef_irr_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span>season <span class="op">=</span> <span class="va">aggregated_county_to_nation_irr</span><span class="op">$</span><span class="va">season</span>, <span class="va">coef_irr_data</span><span class="op">)</span></span>
<span><span class="va">coef_irr_data</span></span>
<span><span class="co">#&gt;        season ili_isoweekmean7_13_pr100      irr     q025     q975       tag</span></span>
<span><span class="co">#&gt;  1: 2009/2010                0.03380077 1.034379 1.026782 1.042032 from_coef</span></span>
<span><span class="co">#&gt;  2: 2010/2011                0.03246441 1.032997 1.025410 1.040640 from_coef</span></span>
<span><span class="co">#&gt;  3: 2011/2012                0.03514786 1.035773 1.028166 1.043436 from_coef</span></span>
<span><span class="co">#&gt;  4: 2012/2013                0.03170748 1.032216 1.024634 1.039853 from_coef</span></span>
<span><span class="co">#&gt;  5: 2013/2014                0.03902228 1.039794 1.032157 1.047487 from_coef</span></span>
<span><span class="co">#&gt;  6: 2014/2015                0.03179648 1.032307 1.024726 1.039945 from_coef</span></span>
<span><span class="co">#&gt;  7: 2015/2016                0.03754698 1.038261 1.030635 1.045943 from_coef</span></span>
<span><span class="co">#&gt;  8: 2016/2017                0.03217375 1.032697 1.025112 1.040338 from_coef</span></span>
<span><span class="co">#&gt;  9: 2017/2018                0.03821602 1.038956 1.031325 1.046643 from_coef</span></span>
<span><span class="co">#&gt; 10: 2018/2019                0.03000346 1.030458 1.022890 1.038082 from_coef</span></span>
<span><span class="co">#&gt; 11: 2019/2020                0.03530514 1.035936 1.028327 1.043600 from_coef</span></span></code></pre></div>
<p>rbindlist the two datasets together.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">total_data_irr</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">coef_irr_data</span>, <span class="va">aggregated_county_to_nation_irr</span><span class="op">)</span>, use.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">total_data_irr</span><span class="op">[</span>, <span class="va">ili_isoweekmean7_13_pr100</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span></span>
<span><span class="va">total_data_irr</span></span>
<span><span class="co">#&gt;        season      irr     q025     q975        tag</span></span>
<span><span class="co">#&gt;  1: 2009/2010 1.034379 1.026782 1.042032  from_coef</span></span>
<span><span class="co">#&gt;  2: 2010/2011 1.032997 1.025410 1.040640  from_coef</span></span>
<span><span class="co">#&gt;  3: 2011/2012 1.035773 1.028166 1.043436  from_coef</span></span>
<span><span class="co">#&gt;  4: 2012/2013 1.032216 1.024634 1.039853  from_coef</span></span>
<span><span class="co">#&gt;  5: 2013/2014 1.039794 1.032157 1.047487  from_coef</span></span>
<span><span class="co">#&gt;  6: 2014/2015 1.032307 1.024726 1.039945  from_coef</span></span>
<span><span class="co">#&gt;  7: 2015/2016 1.038261 1.030635 1.045943  from_coef</span></span>
<span><span class="co">#&gt;  8: 2016/2017 1.032697 1.025112 1.040338  from_coef</span></span>
<span><span class="co">#&gt;  9: 2017/2018 1.038956 1.031325 1.046643  from_coef</span></span>
<span><span class="co">#&gt; 10: 2018/2019 1.030458 1.022890 1.038082  from_coef</span></span>
<span><span class="co">#&gt; 11: 2019/2020 1.035936 1.028327 1.043600  from_coef</span></span>
<span><span class="co">#&gt; 12: 2009/2010 1.034434 1.024874 1.042590 aggregated</span></span>
<span><span class="co">#&gt; 13: 2010/2011 1.033053 1.023506 1.041198 aggregated</span></span>
<span><span class="co">#&gt; 14: 2011/2012 1.035828 1.026256 1.043996 aggregated</span></span>
<span><span class="co">#&gt; 15: 2012/2013 1.032271 1.022731 1.040410 aggregated</span></span>
<span><span class="co">#&gt; 16: 2013/2014 1.039849 1.030240 1.048048 aggregated</span></span>
<span><span class="co">#&gt; 17: 2014/2015 1.032363 1.022822 1.040503 aggregated</span></span>
<span><span class="co">#&gt; 18: 2015/2016 1.038316 1.028721 1.046503 aggregated</span></span>
<span><span class="co">#&gt; 19: 2016/2017 1.032752 1.023208 1.040895 aggregated</span></span>
<span><span class="co">#&gt; 20: 2017/2018 1.039011 1.029409 1.047204 aggregated</span></span>
<span><span class="co">#&gt; 21: 2018/2019 1.030513 1.020990 1.038639 aggregated</span></span>
<span><span class="co">#&gt; 22: 2019/2020 1.035991 1.026417 1.044160 aggregated</span></span>
<span><span class="co">#&gt;        season      irr     q025     q975        tag</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">total_data_irr</span>, </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    x <span class="op">=</span> <span class="va">season</span>,</span>
<span>    group <span class="op">=</span> <span class="va">tag</span>, </span>
<span>    color <span class="op">=</span> <span class="va">tag</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span> </span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_pointrange</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span></span>
<span>    y <span class="op">=</span> <span class="va">irr</span>,</span>
<span>    ymin <span class="op">=</span> <span class="va">q025</span>,</span>
<span>    ymax <span class="op">=</span> <span class="va">q975</span></span>
<span>  <span class="op">)</span>,</span>
<span>  position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html" class="external-link">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Incident risk ratio"</span><span class="op">)</span></span>
<span><span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Incident risk ratio for ILI per season"</span><span class="op">)</span></span>
<span><span class="va">q</span></span></code></pre></div>
<p><img src="attrib_files/figure-html/unnamed-chunk-30-1.png" width="576"></p>
<p>As we can see these intervals are very similar.</p>
<p>The benefit of the simulated approach is that this process will be equally easy no matter the complexity of what we want to compute the IRR for. We do not have to take into account the variance-covariance matrix at any stage.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p><a href="https://www.csids.no" class="external-link"><img src="https://www.csids.no/resources/logo/logo_full_blue.svg" width="200"></a></p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Crafted by <a href="https://www.rwhite.no" class="external-link">Richard Aubrey White</a>, Aurora Christine Hofman.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
